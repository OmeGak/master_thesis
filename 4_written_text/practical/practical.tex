\documentclass[../main/main.tex]{subfiles}

\begin{document}

\section{Overview of exercises (PART I)}

\begin{enumerate}
\item limb-darkening scattering exercise we did during the course. 
— You can look into your notes from that, and I attach here also a sample program which you can use a base. After you have familiarised yourself with this, you can start to think bout how you would go about to extend this to a 3D setting (assuming isotropic scattering). 

\item (As prep for Monte-Carlo school) here is a script computing a UV resonance P-Cygni line in spherically symmetric wind with v beta-law. At top of routine, a few exercises are given, where you can modify and play around with code. Monte-Carlo program which computes a UV resonance spectral line from a fast outflowing spherically symmetric stellar wind (if you were not cc’d on that email, let me know so that I can send you the files as well). At the top of that little script, there are a few suggestions for exercises (additions) you could do to that program, in order to learn a bit more about the general workings of Monte-Carlo radiative transfer in this context.  
— So that might be a good idea for you to do as well !   (And you can also ask the others in the group for some tips etc. then.) 

\item Some background reading: 
\begin{itemize}
\item Attached mc manual by Puls. 
\item Paper by Sundqvist+ 2010 (Appendix, I think). 
\end{itemize}
\end{enumerate}


\section{Overview of exercises (PART II)}
\begin{enumerate}
\item calculate the probability distribution to sample from in the case of Eddington limb darkening for the initial distribution (see \ref{Eddington limb darkening adaptation}).
\item calculate analytical solution for simplified problem in \ref{PCYG FIRST adaptation} in the case that \texttt{mu = 1}.
\item perform convergence analysis
\end{enumerate}


\newpage
\section{Limb darkening}

\label{limb_darkening_discussion}

\subsubsection{2D Case}
We again have $\mu = \cos(\theta)$. The solution of the radiative transfer equation in \underline{plane-parallel syummetry} with frequency-independent absorption and emission, is 
\begin{equation}
I(\mu) = I_1 (0.4 + 0.6\mu)
\end{equation}
In the Monte Carlo code, the photons are sorted according to the direction that they leave the atmosphere.

\paragraph{Goal}
Calculates the angular dependence of photon's emitted from a plane-parallel, grey atmosphere of radial optical depth \texttt{taumax}. The value of \texttt{tau} determines the position of the photon

\paragraph{Variables and Algorithm}
\begin{itemize}
\item \texttt{muarray} contains emergent photons
\item \texttt{na} number of channels
\item \texttt{dmu} = 1/\texttt{na} width of channels
\item \texttt{nphot} number of photons
\item \texttt{taumax} maximum optical depth
\end{itemize}

\begin{algorithm}
\caption{Limb darkening: compute quantitiy of photons}\label{limb_darkening}
\begin{algorithmic}
\State initialization \\
\quad radial optical depth $\tau$ \\
\quad direction $\mu$

\For{all photons} 

\State $\boxed{\tau = \tau_{max}}$
	\While{\texttt{tau} $\geq 0$} 
	
	\State compute scattering angle \texttt{mu}
	\If{tau $\geq$ taumax} $\boxed{mu = sqrt(x)}$ (initial distribution)
	\Else{ $\boxed{mu = 2*x = 1}$} (isotropic scattering)
	\EndIf
	
	\State tau\_i = -log(x2) 
	\State tau = tau - tau\_i*mu	
		
	\EndWhile
	\State \textbf{end while}

	\State now we know that the photon has left the photosphere	
	\State compute the distribution of all angles \texttt{mu} at which the photon left the photosphere
	
\EndFor
\State \textbf{end for}

\State visualisation: 
	\begin{itemize}
	\item plot photon numbers from $\mu d\mu$ against \texttt{mu}
	\item plot specific intensity from $d\mu$ against \texttt{mu} against 
	\end{itemize}


\end{algorithmic}
\end{algorithm}


\begin{figure}[!htp]
\centering
\includegraphics[width=0.7\textwidth]{../../introductory_exercises/limb_darkening/number_channels20number_photons100000max_opt_depth10.png}
\caption{histogram for \texttt{mu}}
\label{2D_mu}
\end{figure}
Figure \ref{2D_mu} is according to what is expected $I = I_0(0.4+0.6\mu)$

\newpage
\subsubsection{3D Code}
What changes is this: 
\begin{itemize}
\item introduction of a new angle $\phi$
\item the optical depth has to be updated according to $\phi$ also
\end{itemize}

\begin{figure}[!htp]
\centering
\begin{minipage}{.5\textwidth}
\includegraphics[width=\textwidth]{../../introductory_exercises/limb_darkening/number_channels20number_photons100000max_opt_depth10.png}
\caption{histogram for \texttt{mu}}
\label{3D_mu}
\end{minipage}%
\begin{minipage}{.5\textwidth}
\includegraphics[width=\textwidth]{../../introductory_exercises/limb_darkening/PHI_number_channels20number_photons100000max_opt_depth10.png}
\caption{histogram for \texttt{phi}}
\label{3D_phi}
\end{minipage}
\end{figure}

Figure \ref{3D_mu} and Figure \ref{3D_phi} are according to what is expected, namely $I = I_0(0.4+0.6\mu)$ and a uniform distribution for $phi$, which corresponds to a $I \sim \frac{1}{\phi}$


\newpage
\section{Investigation of program: pcyg.f90}
\subsection{Overview of variables}
\begin{center}
\centering
{\tabulinesep=1.5mm
\begin{tabu}{|c|c|c|}
\hline 
name & explanation & scope \\ \hline \hline

\multicolumn{3}{|c|}{\cellcolor{orange} paramaters} \\ \hline
xk0 & \\ \hline
alpha & \\ \hline
beta & \\ \hline \hline

\multicolumn{3}{|c|}{\cellcolor{orange} start frequency of the photon} \\ \hline
xstart & start frequency & \\ \hline
vmin & & \\ \hline
vmax  & & \\ \hline

\multicolumn{3}{|c|}{\cellcolor{orange}angle of the photon} \\ \hline
xmuestart & start angle \\ \hline
xmuein & incident angle \\ \hline
xmueou & outward angle \\ \hline
\cellcolor{yellow} pstart & impact parameter \\ \hline
xnew & new photon frequency \\ \hline \hline

\multicolumn{3}{|c|}{\cellcolor{orange} optical depth} \\ \hline
tau & optical depth \\ \hline

\multicolumn{3}{|c|}{\cellcolor{orange} number of photons admin} \\ \hline
nphot & number of photons \\ \hline
nin & photons scattered back into core & \\ \hline
nout & photons escaped & \\ \hline \hline

\multicolumn{3}{|c|}{\cellcolor{orange} functions} \\ \hline
func & velocity profile \\ 
	& r & distance from center of star \\ \hline
	
xmueout & sign of outwards angle & \\ 
& xk0 & \\ 
& alpha & \\ 
& r & \\ 
& v & \\ 
& sigma & \\ \hline
\end{tabu}}
\end{center}

\newpage
\subsection{Mathematical things that are noteworthy}

\paragraph{General working}
\begin{center}
\begin{tikzpicture}
[node distance=2.5cm,auto,>=latex']
    \node [int] (a) {\texttt{pcyg.f90}};
    \node (b) [left of=a,node distance=4cm, coordinate] {a};
    \node (c) [right of=a,node distance=4cm, coordinate] {a};
    \path[->] (b) edge node {\texttt{xstart}} (a);
    \path[->] (a) edge node {\texttt{xnew}} (c);
\end{tikzpicture}
\end{center}
The photons are sorted according to \texttt{xnew}.

\paragraph{Practical formula}
\begin{itemize}
\item emission angle $\mu = \cos(\theta)$
\item according p-ray $p = \sqrt{1-\mu^2} = \sin(\theta)$
\item incident angle $xmuin = \sqrt{1-\left(\frac{pstart}{r}\right)^2}$
\end{itemize}

\paragraph{Geometry \& Symmetry assumptions}
\begin{itemize}
\item spherical geometry
\end{itemize}

\newpage
\subsection{Exercises}
\subsubsection{Investigation of original code}
In original version of the code, all photons are released isotropially from the photosphere.

\begin{figure}[!htp]
\centering
\includegraphics[width=0.5\textwidth]{../../introductory_exercises/P_Cygni_profile_UV_resonance/npot6xk0100alpha0beta1test0.png}
\caption{Original version of the code}
\end{figure}

\newpage
\subsubsection{First adaptation: what if all photons are released radially from photosphere?}
\label{PCYG FIRST adaptation}
\paragraph{Release photons radially: experiments}
What would happen with line-profile, if you assumed all photons
were released radially from photopshere?
\begin{itemize}
\item In other words $\texttt{xmuestart} = 1$. Results in Figure \ref{PCyg_mu=1}.
\item This is implemented under the test case \texttt{test\_number=1}.
\end{itemize}

\begin{figure}[!htbp]
\centering
\includegraphics[width=0.5\textwidth]{../../introductory_exercises/P_Cygni_profile_UV_resonance/npot6xk0100alpha0beta1test1.png}
\caption{First adaptation}
\label{PCyg_mu=1}
\end{figure}

\paragraph{Derive analytic expression} See also slide Sundqvist 26/49. 

\begin{itemize}
\item since \texttt{mu = 1} we have for the velocity profile that $v = v_{\infty}(1-b/r)^{\beta}$
\item a scaled version of the above yields 
\begin{equation}
u = \frac{v(r)}{v_{\infty}} = \left(1 - \frac{r_{\infty}}{r} \right)^{\beta} \in [0..1] 
\label{u_profile}
\end{equation}
\item Doppler shift: $x_{CMF} = x_{REF} - \mu u$
\item condition for resonance from Sobolov approximation (to be studied later): $x_{CMF}= 0$ thus 
\begin{equation}
x_{RF} = \mu u
\label{analytic_profile}
\end{equation}
or thus $u_{int} = x_{REF}$ and than solve Equation \ref{u_profile} for $r_{int}$
\item Equation \ref{analytic_profile} can be solved for the frequency, namely 
\begin{equation}
x = \left(1 - \frac{r_{\infty}}{r} \right)^{\beta}
\end{equation}
\item thus 
\begin{equation*}
x^{-\beta} = 1 - \frac{r_{\infty}}{r}
\end{equation*}
\begin{equation*}
r(1-x^{-\beta}) = r_{\infty}
\end{equation*}
thus \begin{equation}
r = \frac{r_{\infty}}{1-x^{-\beta}}
\end{equation}
\item then the calculation of the optical depth proceeds as follows:
\begin{equation}
\tau = \frac{\texttt{xkO}}{rv^{2-\alpha}(1+\texttt{muein}^2 \sigma)}
\end{equation}
where
\begin{itemize}
\item $v = \left(1 - \frac{b}{r} \right)^{\beta} $
\item $\frac{dv}{dr} = \beta \frac{b}{r^2}\left( 1 - \frac{b}{r} \right)^{\beta - 1}$
\item $\sigma = \frac{dv}{dr}\frac{r}{v}-1$
\end{itemize}
\end{itemize}

\newpage
\subsubsection{Second adaptation: isotropic scattering}
\label{isotropic_scattering}
What would happen to line-profile, is you assumed scattering
!was isotropic (i.e., NOT following Sobolev-distrobution)
\begin{itemize}
\item test case number 2
\end{itemize}

\begin{figure}[!htp]
\centering
\includegraphics[width=0.5\textwidth]{../../introductory_exercises/P_Cygni_profile_UV_resonance/npot6xk0100alpha0beta1test2.png}
\caption{Second adaptation}
\end{figure}

The \textit{grosso modo} form has not changed, although the scaling has changed.

\newpage
\subsubsection{Third adaptation: introduction of Eddington limb-darkening}
\label{Eddington limb darkening adaptation}
Put Eddington limb-darkening in. What happens? 

\paragraph{General discussion: Eddington limb darkening}
The data are taken from Christensen, 2015.
\begin{itemize}
\item the source function $S= <I> = a + b\tau_{\nu}$ with $a= \frac{\sigma}{2 \pi}T_{eff}^4$ and $b = \frac{3 \sigma}{4 \pi}T_{eff}^4$
\item solve the equation
\item this yields $\frac{I(\theta)}{I(0)} = \frac{a+b\cos(\theta)}{a+b} = \frac{2}{5} + \frac{3}{5}\cos(\theta)$
\end{itemize}
\begin{figure}[!htp]
\centering
\includegraphics[width=0.7\textwidth]{../../introductory_exercises/P_Cygni_profile_UV_resonance/Eddington_limb_darkening.png}
\caption{Eddington limb darkening (two times the same plot with $\mu =  \cos(\theta)$ }
\end{figure}

\noindent\fbox{
  \parbox{\textwidth}{
for which star are the exerpimental data and what assumptions are used in the theory?
}} \\
\\
Let us thus first review the emmission case where the flux in each directino is isotropic (paragraph \ref{isotropic_scattering}) $I(\theta) = I$
\begin{itemize}
\item the specific intensity $I_{\nu}(\mu) = \frac{dE_{\nu}}{\cos(\theta) dA dt d\nu d\Omega} = \frac{dE_{\nu}}{\mu dA dt d\nu d\Omega}$ 
\item the flux $F_{\nu} = \int_{\Omega} I_{\nu} \cos(\theta) d\Omega$ is in this case isotropic thus
\begin{equation}
\xi = \int_0^{\mu} F_{\nu} d\mu = \int_0^{\mu} \int_{\Omega} I_{\nu} \cos(\theta) d\Omega d\mu = A \int_0^{\mu} \mu d\mu   
\end{equation}
with the condition that $\mu$ satisfies a probability distribution: 
\begin{equation}
1 = \int_{-1}^{1} F_{\nu} d\mu = \int_{-1}^{1} \int_{\Omega} I_{\nu} \cos(\theta) d\Omega d\mu = \frac{A}{2}
\label{isotropic_flux_isotropic_intensity_prob_dist}
\end{equation}
thus $A=2$.
\end{itemize}

\newpage
\paragraph{Application to exercise}
Now we look at a new case where the photons need to be emitted following a distrubution that corresponds to $I(\theta) = I(0)(0.4+0.6\cos(\theta))$. In the code this corresponds to \texttt{test\_number = 3}. 
\begin{itemize}
\item in this case the flux $F_{\nu} = \int_{\Omega} I_{\nu} \cos(\theta) d\Omega$ is also isotropic but satisfies
\begin{equation}
F_{\nu} = \int_{\Omega} I_{\nu}(0)[0.4+0.6\cos(\theta)] \cos(\theta) d\Omega
\end{equation} 
\begin{equation}
\xi = \int_0^{\mu} F_{\nu} d\mu = A \int_0^{\mu} (0.4+0.6\mu) \mu d\mu   
\end{equation}
subject to the condition -very similar to Equation \ref{isotropic_flux_isotropic_intensity_prob_dist} - that
\begin{equation}
1 = \int_{-1}^{1} F_{\nu} d\mu = \frac{2A}{5} + \frac{A}{3} = \frac{11A}{15}
\end{equation}
thus $A = \frac{15}{11}$
\end{itemize}

\newpage
\subsubsection{Fourth adaptaion: photospheric line-profile}
Challening: Put photospheric line-profile (simple Gaussian) in
!What happens? Test on xk0=0 (opacity =0) case.

\begin{itemize}
\item test case number 4 (not yet implemented)
\end{itemize}


\newpage
\subsubsection{Convergence analysis}


\newpage
\section{Mass loss from inhomogeneous hot star winds (Sundqvist)}
\begin{itemize}
\item GOAL: synthesis of UV resonance lines from inhomogeneous 2D winds
\begin{itemize}
\item clumped in density
\item clumped in velocity
\item effects of non-void inter-clump medium
\end{itemize}

\item WIND MODELS
\begin{itemize}
\item symmetry assumptions
\begin{itemize}
\item 1D: spherical symmetry
\item 2D: symmetry in $\Phi$
\end{itemize}

\item models
\begin{enumerate}

\item time-dependent radiation-hydrodynamic from Puls and Owocki (POF)
\begin{itemize}
\item 1D
\item isothermal flow
\item perturbations triggered by photospheric sound waves
\end{itemize}

\item time-dependent radiation-hydrodynamic from Feldmeier (FPP)
\begin{itemize}
\item 1D
\item treatment of energy equation
\item perturbations triggered by photospeheric sound waves or Langevin perturbagions (photospheric turbulence)
\end{itemize}

\item stochastic model, clumped in density
\begin{itemize}
\item smooth winds with $v_{\beta} = (1-b/r)^{\beta}$ with $\beta = 1$
\item clumping factor $f_{cl}$
\end{itemize}

\item stochastic model, clumped in density and in velocity (non-monotonic velocity field)
\begin{itemize}
\item smooth winds with $v_{\beta} = (1-b/r)^{\beta}$ with $\beta = 1$
\item clumping factor $f_{cl}$
\end{itemize}
\end{enumerate}

\end{itemize}

\item RADIATIVE TRANSFER (MC-2D)
\end{itemize}

\newpage
\section{Asymptotic preserving Monte Carlo methods for radiative transfer equation in diffusion limit (Dimarco+ 2018)}
\subsection{Goldstein-Taylor}
\subsection{Radiative transfer}

\end{document}